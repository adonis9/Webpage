<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horse Draw Manager - Live Regenerate</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
h1 { text-align:center; }
.section { background:white; padding:15px; margin-bottom:20px; border-radius:8px; }
input, select, textarea, button { width:100%; padding:8px; margin:5px 0; }
button { background:#2c3e50; color:white; border:none; cursor:pointer; }
.delete { background:#e74c3c; }
.draw { background:#27ae60; }
.race { border:1px solid #ddd; padding:10px; margin-top:10px; border-radius:5px; }
.horse-item { display:flex; justify-content:space-between; margin-bottom:3px; }
</style>
</head>
<body>

<!-- LOCK SCREEN -->
<div id="lockScreen" style="text-align:center; margin-top:120px;">
  <h2>üîí Private Page</h2>
  <p>Enter Access Code</p>
  <input type="password" id="accessCode" placeholder="Access code">
  <button onclick="unlock()">Enter</button>
  <p id="error" style="color:red;"></p>
</div>

<!-- APP CONTENT -->
<div id="appContent" style="display:none;">

<h1>üêé Horse Draw Manager - Live Regenerate</h1>
<button class="delete" onclick="deleteAll()">Delete All Data</button>

<div class="section">
<h2>Add / Edit Horses</h2>
<textarea id="horseNames" placeholder="One horse per line"></textarea>
<select id="houseSelect"></select>
<input id="newHouse" placeholder="Or new house name">
<button onclick="addHorses()">Add Horse(s)</button>
</div>

<div class="section">
<h2>Horses List (Remove if Not Participating)</h2>
<div id="horseList"></div>
</div>

<div class="section">
<h2>Manual Race Creation</h2>
<input id="raceName" placeholder="Race name">
<button onclick="addRace()">Add Race</button>
<div id="races"></div>
</div>

<div class="section">
<h2>üèÅ Automatic Draw Results</h2>
<button class="draw" onclick="generateAutoDraw()">Regenerate Draw</button>
<div id="drawResults"></div>
</div>

</div>

<script>
window.onload = function() {
  const lockScreen = document.getElementById("lockScreen");
  const appContent = document.getElementById("appContent");
  const accessCode = document.getElementById("accessCode");
  const error = document.getElementById("error");
  const drawResults = document.getElementById("drawResults");
  const horseListDiv = document.getElementById("horseList");
  const racesDiv = document.getElementById("races");

  const SECRET_CODE = "HORSE2026";
  if (sessionStorage.getItem("accessGranted")) unlock(true);

  function unlock(auto=false){
    if(auto || accessCode.value === SECRET_CODE){
      lockScreen.style.display="none";
      appContent.style.display="block";
      sessionStorage.setItem("accessGranted","true");
    } else { error.textContent="Incorrect access code"; }
  }
  window.unlock = unlock;

  // Preloaded horses
  let horses = [];
  let races = [];
  const preload=[
    ["Koxera Monte Barro",["Sabe Na Mundo","Arbisa","Pisadelo","Fradu Fra"]],
    ["Koxera Nene Lapinha",["Forca Imigrante","America Dreams","Bless"]],
    ["Koxera Lele",["Miss Fogo"]],
    ["Clube Juvenil",["Rainha Das Ilhas"]],
    ["Koxera de Neto",["Mestre Moita","Showtime"]],
    ["EECV",["Santiago Sweetie","Djabraba BAYC","Eytiana","Comandate","Cidade velha","stylish"]]
  ];

  if(localStorage.getItem("horses")){
    horses = JSON.parse(localStorage.getItem("horses"));
    races = JSON.parse(localStorage.getItem("races")) || [];
  } else {
    preload.forEach(h => h[1].forEach(n => horses.push({name:n,house:h[0]})));
  }

  function save(){
    localStorage.setItem("horses",JSON.stringify(horses));
    localStorage.setItem("races",JSON.stringify(races));
    updateHouses();
    renderHorseList();
    renderRaces();
    generateAutoDraw(); // auto-update draw
  }

  function updateHouses(){
    const hs=[...new Set(horses.map(h=>h.house))];
    const houseSelect = document.getElementById("houseSelect");
    houseSelect.innerHTML="";
    hs.forEach(h=>{
      const o=document.createElement("option");
      o.value=h; o.textContent=h;
      houseSelect.appendChild(o);
    });
  }

  function addHorses(){
    let house = document.getElementById("newHouse").value.trim() || document.getElementById("houseSelect").value;
    if(!house) return alert("House required");
    document.getElementById("horseNames").value.split("\n").forEach(n=>{
      n = n.trim();
      if(n && !horses.find(h=>h.name===n)) horses.push({name:n,house});
    });
    document.getElementById("horseNames").value="";
    document.getElementById("newHouse").value="";
    save();
  }

  function removeHorse(index){
    if(!confirm("Remove this horse from draw?")) return;
    horses.splice(index,1);
    save();
  }

  function renderHorseList(){
    horseListDiv.innerHTML="";
    horses.forEach((h,i)=>{
      const div = document.createElement("div");
      div.className="horse-item";
      div.innerHTML=`<span>${h.name} (${h.house})</span> 
      <button onclick="removeHorse(${i})">Remove</button>`;
      horseListDiv.appendChild(div);
    });
  }

  function addRace(){
    let raceName = document.getElementById("raceName").value.trim();
    if(!raceName) return alert("Race name required");
    races.push({name: raceName, horses: []});
    document.getElementById("raceName").value="";
    save();
  }

  function addToRace(raceIndex, horseIndex){
    const h = horses[horseIndex];
    if(!races[raceIndex].horses.includes(h)) races[raceIndex].horses.push(h);
    save();
  }

  function removeFromRace(rIndex,hIndex){
    races[rIndex].horses.splice(hIndex,1);
    save();
  }

  function renderRaces(){
    racesDiv.innerHTML="";
    races.forEach((r,ri)=>{
      const div = document.createElement("div");
      div.className="race";
      div.innerHTML=`<strong>${r.name}</strong><br>`;
      r.horses.forEach((h,hi)=>{
        div.innerHTML+=`${h.name} (${h.house}) <button onclick="removeFromRace(${ri},${hi})">Remove</button><br>`;
      });
      const sel = document.createElement("select");
      horses.forEach((h,i)=>{
        const o = document.createElement("option");
        o.value=i; o.textContent=`${h.name} (${h.house})`;
        sel.appendChild(o);
      });
      const b = document.createElement("button");
      b.textContent="Add Horse";
      b.onclick=()=>addToRace(ri,sel.value);
      div.appendChild(sel);
      div.appendChild(b);
      racesDiv.appendChild(div);
    });
  }

  function shuffle(a){ return a.sort(()=>Math.random()-0.5); }

  function generateAutoDraw(){
    drawResults.innerHTML="";
    if(horses.length<2) return;

    let shuffled = shuffle([...horses]);
    let heats = [];
    while(shuffled.length){
      let heat=[];
      let housesInHeat = new Set();
      for(let i=0;i<shuffled.length && heat.length<3;){
        let h = shuffled[i];
        let houseCount = shuffled.filter(x=>x.house===h.house).length;
        let allowSameHouse = houseCount>5;
        if(!housesInHeat.has(h.house) || allowSameHouse){
          heat.push(h);
          housesInHeat.add(h.house);
          shuffled.splice(i,1);
        } else { i++; }
      }
      while(heat.length<2 && shuffled.length) heat.push(shuffled.shift());
      heats.push(heat);
    }

    heats.forEach((h,i)=>{
      const d=document.createElement("div");
      d.className="race";
      d.innerHTML=`<strong>Heat ${i+1}</strong><br>Horses racing (${h.length}):<ul>`;
      h.forEach(x=>d.innerHTML+=`<li>${x.name} (${x.house})</li>`);
      d.innerHTML+="</ul>";
      drawResults.appendChild(d);
    });
  }

  function deleteAll(){
    if(!confirm("Delete everything?")) return;
    localStorage.clear();
    location.reload();
  }

  // Expose to global
  window.addHorses=addHorses;
  window.removeHorse=removeHorse;
  window.addRace=addRace;
  window.addToRace=addToRace;
  window.removeFromRace=removeFromRace;
  window.generateAutoDraw=generateAutoDraw;
  window.deleteAll=deleteAll;

  // Initialize
  updateHouses();
  renderHorseList();
  renderRaces();
  generateAutoDraw(); // pre-generate on load
};
</script>

</body>
</html>
