<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horse Draw Manager</title>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
h1 { text-align:center; }
.section { background:white; padding:15px; margin-bottom:20px; border-radius:8px; }
input, select, textarea, button { width:100%; padding:8px; margin:5px 0; }
button { background:#2c3e50; color:white; border:none; cursor:pointer; }
.delete { background:#e74c3c; }
.draw { background:#27ae60; }
.race { border:1px solid #ddd; padding:10px; margin-top:10px; border-radius:5px; }
</style>
</head>

<body>

<!-- üîí LOCK SCREEN -->
<div id="lockScreen" style="text-align:center; margin-top:120px;">
  <h2>üîí Private Page</h2>
  <p>Enter Access Code</p>
  <input type="password" id="accessCode" placeholder="Access code">
  <button onclick="unlock()">Enter</button>
  <p id="error" style="color:red;"></p>
</div>

<!-- üîì APP CONTENT -->
<div id="appContent" style="display:none;">

<h1>üêé Horse Draw Manager</h1>
<button class="delete" onclick="deleteAll()">Delete All Data</button>

<div class="section">
<h2>Add / Edit Horses</h2>
<textarea id="horseNames" placeholder="One horse per line"></textarea>
<select id="houseSelect"></select>
<input id="newHouse" placeholder="Or new house name">
<button onclick="addHorses()">Add Horse(s)</button>
</div>

<div class="section">
<h2>Create Race</h2>
<input id="raceName" placeholder="Race name">
<button onclick="addRace()">Add Race</button>
</div>

<div class="section">
<h2>Races (Assign Horses)</h2>
<div id="races"></div>
</div>

<div class="section">
<h2>üèÅ Draw Results (All Races)</h2>
<button class="draw" onclick="generateAllDraws()">Generate Draw for All Races</button>
<div id="drawResults"></div>
</div>

</div>

<script>
/* üîë ACCESS CODE */
const SECRET_CODE = "HORSE2026";
if (sessionStorage.getItem("accessGranted")) unlock(true);

function unlock(auto=false){
  if(auto || accessCode.value === SECRET_CODE){
    lockScreen.style.display="none";
    appContent.style.display="block";
    sessionStorage.setItem("accessGranted","true");
  } else {
    error.textContent="Incorrect access code";
  }
}

/* üêé DATA */
let horses=[], races=[];

const preload=[
["Koxera Monte Barro",["Sabe Na Mundo","Arbisa","Pisadelo","Fradu Fra"]],
["Koxera Nene Lapinha",["Forca Imigrante","America Dreams","Bless"]],
["Koxera Lele",["Miss Fogo"]],
["Clube Juvenil",["Rainha Das Ilhas"]],
["Koxera de Neto",["Mestre Moita","Showtime"]],
["EECV",["Santiago Sweetie","Djabraba BAYC","Eytiana","Comandate","Cidade velha","stylish"]]
];

if(localStorage.getItem("horses")){
  horses=JSON.parse(localStorage.getItem("horses"));
  races=JSON.parse(localStorage.getItem("races"));
}else{
  preload.forEach(h=>{
    h[1].forEach(n=>horses.push({name:n,house:h[0]}));
  });
}

function save(){
  localStorage.setItem("horses",JSON.stringify(horses));
  localStorage.setItem("races",JSON.stringify(races));
  updateHouses();
}

function updateHouses(){
  const hs=[...new Set(horses.map(h=>h.house))];
  houseSelect.innerHTML="";
  hs.forEach(h=>{
    const o=document.createElement("option");
    o.value=h; o.textContent=h;
    houseSelect.appendChild(o);
  });
}

function addHorses(){
  let house=newHouse.value.trim()||houseSelect.value;
  if(!house)return alert("House required");
  horseNames.value.split("\n").forEach(n=>{
    n=n.trim();
    if(n && !horses.find(h=>h.name===n))
      horses.push({name:n,house});
  });
  horseNames.value=""; newHouse.value="";
  save(); render();
}

function addRace(){
  if(!raceName.value.trim())return;
  races.push({name:raceName.value,horses:[]});
  raceName.value="";
  save(); render();
}

function addToRace(r,i){
  if(!races[r].horses.includes(horses[i]))
    races[r].horses.push(horses[i]);
  save(); render();
}

function removeFromRace(r,i){
  races[r].horses.splice(i,1);
  save(); render();
}

function shuffle(a){ return a.sort(()=>Math.random()-0.5); }

function render(){
  racesDiv.innerHTML="";
  races.forEach((r,ri)=>{
    const d=document.createElement("div");
    d.className="race";
    d.innerHTML=`<strong>${r.name}</strong>`;
    r.horses.forEach((h,hi)=>{
      d.innerHTML+=`${h.name} (${h.house})
      <button onclick="removeFromRace(${ri},${hi})">Remove</button><br>`;
    });
    const sel=document.createElement("select");
    horses.forEach((h,i)=>{
      const o=document.createElement("option");
      o.value=i; o.textContent=`${h.name} (${h.house})`;
      sel.appendChild(o);
    });
    const b=document.createElement("button");
    b.textContent="Add Horse";
    b.onclick=()=>addToRace(ri,sel.value);
    d.appendChild(sel); d.appendChild(b);
    racesDiv.appendChild(d);
  });
  updateHouses();
}

/* üèÅ AUTO DRAW FOR ALL RACES */
function generateAllDraws(){
  drawResults.innerHTML="";

  races.forEach(r=>{
    if(r.horses.length < 2) return;

    let shuffled = shuffle([...r.horses]);
    let heats = [];

    while(shuffled.length){
      if(shuffled.length === 4){
        heats.push(shuffled.splice(0,2));
        heats.push(shuffled.splice(0,2));
      } else if (shuffled.length === 2 || shuffled.length === 3){
        heats.push(shuffled.splice(0));
      } else {
        heats.push(shuffled.splice(0,3));
      }
    }

    heats.forEach((h,i)=>{
      const d=document.createElement("div");
      d.className="race";
      d.innerHTML=`<strong>${r.name} ‚Äì Heat ${i+1}</strong>
      <br>Horses racing (${h.length}):<ul>`;
      h.forEach(x=>d.innerHTML+=`<li>${x.name} (${x.house})</li>`);
      d.innerHTML+="</ul>";
      drawResults.appendChild(d);
    });
  });
}

function deleteAll(){
  if(!confirm("Delete everything?"))return;
  localStorage.clear();
  location.reload();
}

render();
</script>

</body>
</html>
